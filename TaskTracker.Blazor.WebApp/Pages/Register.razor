@page "/register"
@layout EmptyLayout
@using TaskTracker.Blazor.WebApp.Authentication
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthStateProvider

<MudContainer MaxWidth=@MaxWidth.Small
              Class="d-flex align-center justify-center"
              Style="min-height: 100vh;">

    <MudPaper Elevation="8"
              Class="pa-8"
              Style="width: 100%;">

        <MudText Typo=@Typo.h4
                 Align=@Align.Center
                 GutterBottom=@true>
            <MudIcon Icon=@Icons.Material.Filled.Task
                     Size=@Size.Large /> TaskTracker
        </MudText>

        <MudText Typo=@Typo.h6
                 Align=@Align.Center
                 Class="mb-6">
            Create your account
        </MudText>

        <EditForm Model=@registerModel
                  OnValidSubmit=@HandleRegister>
            <DataAnnotationsValidator />

            <MudTextField @bind-Value=@registerModel.FirstName
                          Label="First Name"
                          Variant=@Variant.Outlined
                          Required=@true
                          RequiredError="First name is required"
                          Class="mb-4" />

            <MudTextField @bind-Value=@registerModel.LastName
                          Label="Last Name"
                          Variant=@Variant.Outlined
                          Required=@true
                          RequiredError="Last name is required"
                          Class="mb-4" />

            <MudTextField @bind-Value=@registerModel.Email
                          Label="Email"
                          Variant=@Variant.Outlined
                          InputType=@InputType.Email
                          Required=@true
                          RequiredError="Email is required"
                          Class="mb-4" />

            <MudTextField @bind-Value=@registerModel.Password
                          Label="Password"
                          Variant=@Variant.Outlined
                          InputType=@InputType.Password
                          Required=@true
                          RequiredError="Password is required"
                          Class="mb-4" />

            <MudButton ButtonType=@ButtonType.Submit
                       Variant=@Variant.Filled
                       Color=@Color.Primary
                       FullWidth=@true
                       Size=@Size.Large
                       Disabled=@isLoading
                       Class="mb-4">
                @if (isLoading)
                {
                    <MudProgressCircular Size=@Size.Small
                                         Indeterminate=@true />
                }
                else
                {
                    <text>Sign Up</text>
                }
            </MudButton>
        </EditForm>

        <MudDivider Class="my-4" />

        <MudText Align=@Align.Center>
            Already have an account?
            <MudLink Href="/login"
                     Color=@Color.Primary>
                Sign in
            </MudLink>
        </MudText>

    </MudPaper>
</MudContainer>

@code {
    private RegisterDto registerModel = new();
    private bool isLoading = false;

    private async Task HandleRegister()
    {
        isLoading = true;

        try
        {
           
            var success = await AuthService.RegisterAsync(registerModel);

            if (success)
            {
                
                var loginModel = new LoginDto
                {
                    Email = registerModel.Email,
                    Password = registerModel.Password
                };

                var loginSuccess = await AuthService.LoginAsync(loginModel);

                if (loginSuccess)
                {
                    
                    if (AuthStateProvider is CustomAuthStateProvider customAuthProvider)
                    {
                        customAuthProvider.NotifyAuthenticationStateChanged();
                    }

                    Snackbar.Add("Registration successful! Welcome!", Severity.Success);
                    Navigation.NavigateTo("/");
                }
                else
                {
                    
                    Snackbar.Add("Account created. Please sign in.", Severity.Success);
                    Navigation.NavigateTo("/login");
                }
            }
            else
            {
                Snackbar.Add("Registration failed. Email might be taken.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"An error occurred: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }
}
