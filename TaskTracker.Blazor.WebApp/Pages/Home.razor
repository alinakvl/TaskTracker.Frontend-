@page "/"
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@using TaskTracker.Blazor.WebApp.Authentication
@using TaskTracker.Blazor.WebApp.Components.Shared
@attribute [Authorize]
@inject IBoardService BoardService
@inject ITaskService TaskService
@inject NavigationManager Navigation
@inject IAuthService AuthService

<PageTitle>Dashboard - TaskTracker</PageTitle>

@if (isLoading)
{
    <MudProgressLinear Indeterminate=@true />
}
else
{
    <div class="mb-6">
        <MudText Typo=@Typo.h3
                 Class="mb-2">
            Welcome back, @currentUser?.FirstName!
        </MudText>

        <MudText Typo=@Typo.body1
                 Color=@Color.Default>
            @GetGreetingMessage()
        </MudText>
    </div>

    <MudGrid Class="mb-6">
        <MudItem xs="12"
                 sm="6"
                 md="3">
            <MudPaper Elevation="2"
                      Class="pa-4 stat-card"
                      Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo=@Typo.h6
                                 Style="color: rgba(255,255,255,0.9);">
                            My Boards
                        </MudText>

                        <MudText Typo=@Typo.h3
                                 Style="color: white;"
                                 Class="mt-2">
                            @boards.Count
                        </MudText>
                    </div>

                    <MudIcon Icon=@Icons.Material.Filled.ViewKanban
                             Size=@Size.Large
                             Style="color: rgba(255,255,255,0.5);" />
                </div>

                <MudButton Variant=@Variant.Text
                           Href="/boards"
                           Style="color: white; margin-top: 8px;"
                           StartIcon=@Icons.Material.Filled.ArrowForward>
                    View All
                </MudButton>
            </MudPaper>
        </MudItem>

        <MudItem xs="12"
                 sm="6"
                 md="3">
            <MudPaper Elevation="2"
                      Class="pa-4 stat-card"
                      Style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo=@Typo.h6
                                 Style="color: rgba(255,255,255,0.9);">
                            My Tasks
                        </MudText>

                        <MudText Typo=@Typo.h3
                                 Style="color: white;"
                                 Class="mt-2">
                            @myTasks.Count
                        </MudText>
                    </div>

                    <MudIcon Icon=@Icons.Material.Filled.Task
                             Size=@Size.Large
                             Style="color: rgba(255,255,255,0.5);" />
                </div>

                <MudButton Variant=@Variant.Text
                           Href="/tasks"
                           Style="color: white; margin-top: 8px;"
                           StartIcon=@Icons.Material.Filled.ArrowForward>
                    View All
                </MudButton>
            </MudPaper>
        </MudItem>

        <MudItem xs="12"
                 sm="6"
                 md="3">
            <MudPaper Elevation="2"
                      Class="pa-4 stat-card"
                      Style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo=@Typo.h6
                                 Style="color: rgba(255,255,255,0.9);">
                            Completed
                        </MudText>

                        <MudText Typo=@Typo.h3
                                 Style="color: white;"
                                 Class="mt-2">
                            @completedTasksCount
                        </MudText>
                    </div>

                    <MudIcon Icon=@Icons.Material.Filled.CheckCircle
                             Size=@Size.Large
                             Style="color: rgba(255,255,255,0.5);" />
                </div>

                <MudText Typo=@Typo.body2
                         Style="color: rgba(255,255,255,0.9); margin-top: 8px;">
                    This week
                </MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="12"
                 sm="6"
                 md="3">
            <MudPaper Elevation="2"
                      Class="pa-4 stat-card"
                      Style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo=@Typo.h6
                                 Style="color: rgba(255,255,255,0.9);">
                            Overdue
                        </MudText>

                        <MudText Typo=@Typo.h3
                                 Style="color: white;"
                                 Class="mt-2">
                            @overdueTasksCount
                        </MudText>
                    </div>

                    <MudIcon Icon=@Icons.Material.Filled.Warning
                             Size=@Size.Large
                             Style="color: rgba(255,255,255,0.5);" />
                </div>

                <MudText Typo=@Typo.body2
                         Style="color: rgba(255,255,255,0.9); margin-top: 8px;">
                    Needs attention
                </MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudPaper Elevation="2"
              Class="pa-4 mb-6">
        <MudText Typo=@Typo.h6
                 Class="mb-3">
            Quick Actions
        </MudText>

        <div class="d-flex flex-wrap gap-2">
            <MudButton Variant=@Variant.Filled
                       Color=@Color.Primary
                       StartIcon=@Icons.Material.Filled.Add
                       Href="/boards/create">
                New Board
            </MudButton>

            <MudButton Variant=@Variant.Outlined
                       Color=@Color.Primary
                       StartIcon=@Icons.Material.Filled.GroupAdd>
                Invite Team
            </MudButton>

            <MudButton Variant=@Variant.Outlined
                       Color=@Color.Default
                       StartIcon=@Icons.Material.Filled.Search>
                Search Tasks
            </MudButton>
        </div>
    </MudPaper>

    <MudGrid>
        <MudItem xs="12"
                 md="8">
            <MudPaper Elevation="2"
                      Class="pa-4 mb-4">
                <div class="d-flex justify-space-between align-center mb-4">
                    <MudText Typo=@Typo.h6>My Tasks</MudText>

                    <MudButton Variant=@Variant.Text
                               Color=@Color.Primary
                               Href="/tasks"
                               EndIcon=@Icons.Material.Filled.ArrowForward>
                        View All
                    </MudButton>
                </div>

                @if (myTasks.Any())
                {
                    <MudList T="string"
                             Dense=@true
                             Clickable=@true>
                        @foreach (var task in myTasks.Take(5))
                        {
                            <MudListItem T="string"
                                         OnClick=@(() => Navigation.NavigateTo($"/tasks/{task.Id}"))
                                         Style="cursor: pointer; border-radius: 8px;">
                                <div class="d-flex align-center justify-space-between">
                                    <div class="d-flex align-center gap-3"
                                         style="flex: 1;">
                                        <MudCheckBox T="bool"
                                                     Value=@false
                                                     Color=@Color.Primary />

                                        <div>
                                            <MudText Typo=@Typo.body1>
                                                @task.Title
                                            </MudText>

                                            <div class="d-flex gap-2 align-center mt-1">
                                                <MudChip T="string"
                                                         Size=@Size.Small
                                                         Color=@GetPriorityColor(task.Priority)
                                                         Variant=@Variant.Text>
                                                    @task.PriorityName
                                                </MudChip>

                                                @if (task.DueDate.HasValue)
                                                {
                                                    <MudChip T="string"
                                                             Size=@Size.Small
                                                             Icon=@Icons.Material.Filled.CalendarToday
                                                             Color=@GetDueDateColor(task.DueDate.Value)>
                                                        @task.DueDate.Value.ToString("MMM dd")
                                                    </MudChip>
                                                }
                                            </div>
                                        </div>
                                    </div>

                                    <MudIconButton Icon=@Icons.Material.Filled.ChevronRight
                                                   Size=@Size.Small />
                                </div>
                            </MudListItem>

                            <MudDivider />
                        }
                    </MudList>
                }
                else
                {
                    <div class="text-center py-8">
                        <MudIcon Icon=@Icons.Material.Filled.TaskAlt
                                 Size=@Size.Large
                                 Color=@Color.Default
                                 Class="mb-2" />

                        <MudText Typo=@Typo.body1
                                 Color=@Color.Default>
                            No tasks assigned to you yet
                        </MudText>
                    </div>
                }
            </MudPaper>

            <MudPaper Elevation="2"
                      Class="pa-4">
                <div class="d-flex justify-space-between align-center mb-4">
                    <MudText Typo=@Typo.h6>Recent Boards</MudText>

                    <MudButton Variant=@Variant.Text
                               Color=@Color.Primary
                               Href="/boards"
                               EndIcon=@Icons.Material.Filled.ArrowForward>
                        View All
                    </MudButton>
                </div>

                @if (boards.Any())
                {
                    <MudGrid>
                        @foreach (var board in boards.Take(4))
                        {
                            <MudItem xs="12"
                                     sm="6">
                                <MudCard Elevation="0"
                                         Outlined=@true
                                         Style=@($"cursor: pointer; border-left: 4px solid {board.BackgroundColor};")
                                         @onclick=@(() => Navigation.NavigateTo($"/boards/{board.Id}"))>
                                    <MudCardContent>
                                        <MudText Typo=@Typo.h6
                                                 Class="mb-2">
                                            @board.Title
                                        </MudText>

                                        <div class="d-flex gap-2">
                                            <MudChip T="string"
                                                     Size=@Size.Small
                                                     Icon=@Icons.Material.Filled.Task>
                                                @board.TasksCount Tasks
                                            </MudChip>

                                            <MudChip T="string"
                                                     Size=@Size.Small
                                                     Icon=@Icons.Material.Filled.People>
                                                @board.MembersCount
                                            </MudChip>
                                        </div>
                                    </MudCardContent>
                                </MudCard>
                            </MudItem>
                        }
                    </MudGrid>
                }
                else
                {
                    <div class="text-center py-8">
                        <MudIcon Icon=@Icons.Material.Filled.ViewKanban
                                 Size=@Size.Large
                                 Color=@Color.Default
                                 Class="mb-2" />

                        <MudText Typo=@Typo.body1
                                 Color=@Color.Default
                                 Class="mb-3">
                            No boards yet
                        </MudText>

                        <MudButton Variant=@Variant.Filled
                                   Color=@Color.Primary
                                   StartIcon=@Icons.Material.Filled.Add
                                   Href="/boards/create">
                            Create Your First Board
                        </MudButton>
                    </div>
                }
            </MudPaper>
        </MudItem>

        <MudItem xs="12"
                 md="4">
            <MudPaper Elevation="2"
                      Class="pa-4 mb-4">
                <MudText Typo=@Typo.h6
                         Class="mb-3">
                    Recent Activity
                </MudText>

                <MudTimeline TimelineOrientation=@TimelineOrientation.Vertical
                             TimelinePosition=@TimelinePosition.Start>
                    <MudTimelineItem Size=@Size.Small
                                     Color=@Color.Success>
                        <MudText Typo=@Typo.body2>
                            <strong>Board created</strong>
                        </MudText>
                        <MudText Typo=@Typo.caption
                                 Color=@Color.Default>
                            2 hours ago
                        </MudText>
                    </MudTimelineItem>

                    <MudTimelineItem Size=@Size.Small
                                     Color=@Color.Info>
                        <MudText Typo=@Typo.body2>
                            <strong>Task completed</strong>
                        </MudText>
                        <MudText Typo=@Typo.caption
                                 Color=@Color.Default>
                            5 hours ago
                        </MudText>
                    </MudTimelineItem>
                </MudTimeline>
            </MudPaper>

            <MudPaper Elevation="2"
                      Class="pa-4 mb-4">
                <MudText Typo=@Typo.h6
                         Class="mb-3">
                    Task Priority
                </MudText>

                <div class="priority-bars">
                    <div class="mb-3">
                        <div class="d-flex justify-space-between mb-1">
                            <MudText Typo=@Typo.body2>Critical</MudText>
                            <MudText Typo=@Typo.body2>@GetTaskCountByPriority(4)</MudText>
                        </div>

                        <MudProgressLinear Color=@Color.Error
                                           Value=@GetTaskPercentageByPriority(4)
                                           Size=@Size.Large
                                           Rounded=@true />
                    </div>
                </div>
            </MudPaper>

            <MudPaper Elevation="2"
                      Class="pa-4">
                <MudText Typo=@Typo.h6
                         Class="mb-3">
                    Upcoming Deadlines
                </MudText>

                @if (upcomingTasks.Any())
                {
                    <MudList T="string"
                             Dense=@true>
                        @foreach (var task in upcomingTasks.Take(5))
                        {
                            <MudListItem T="string"
                                         OnClick=@(() => Navigation.NavigateTo($"/tasks/{task.Id}"))
                                         Style="cursor: pointer;">
                                <div>
                                    <MudText Typo=@Typo.body2>
                                        @task.Title
                                    </MudText>

                                    <MudText Typo=@Typo.caption
                                             Color=@GetDueDateTextColor(task.DueDate!.Value)>
                                        @GetDueDateText(task.DueDate!.Value)
                                    </MudText>
                                </div>
                            </MudListItem>

                            <MudDivider />
                        }
                    </MudList>
                }
                else
                {
                    <MudText Typo=@Typo.body2
                             Color=@Color.Default
                             Align=@Align.Center
                             Class="py-4">
                        No upcoming deadlines
                    </MudText>
                }
            </MudPaper>
        </MudItem>
    </MudGrid>
}

<style>
    .stat-card {
        transition: transform 0.2s, box-shadow 0.2s;
        border-radius: 12px !important;
    }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15) !important;
        }

    .priority-bars {
        width: 100%;
    }
</style>

@code {
    private List<BoardDto> boards = new();
    private List<TaskDto> myTasks = new();
    private List<TaskDto> upcomingTasks = new();
    private UserDto? currentUser;
    private bool isLoading = true;

    private int completedTasksCount = 0;
    private int overdueTasksCount = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        isLoading = true;

        try
        {
            currentUser = await AuthService.GetCurrentUserAsync();
            boards = await BoardService.GetMyBoardsAsync();
            myTasks = await TaskService.GetMyTasksAsync();

         
            if (myTasks != null)
            {
                completedTasksCount = myTasks.Count(t => t.PriorityName == "Done");
                overdueTasksCount = myTasks.Count(t => t.DueDate.HasValue && t.DueDate.Value < DateTime.UtcNow);

                upcomingTasks = myTasks
                    .Where(t => t.DueDate.HasValue && t.DueDate.Value > DateTime.UtcNow)
                    .OrderBy(t => t.DueDate)
                    .ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetGreetingMessage()
    {
        var hour = DateTime.Now.Hour;
        if (hour < 12) return "Good morning! Here's what's happening with your projects.";
        if (hour < 18) return "Good afternoon! Let's stay productive.";
        return "Good evening! Time to wrap up today's tasks.";
    }

    private Color GetPriorityColor(int priority)
    {
        return priority switch
        {
            4 => Color.Error,
            3 => Color.Warning,
            2 => Color.Info,
            _ => Color.Success
        };
    }

    private Color GetDueDateColor(DateTime dueDate)
    {
        var daysUntilDue = (dueDate - DateTime.UtcNow).Days;
        if (daysUntilDue < 0) return Color.Error;
        if (daysUntilDue <= 2) return Color.Warning;
        return Color.Default;
    }

    private Color GetDueDateTextColor(DateTime dueDate)
    {
        var daysUntilDue = (dueDate - DateTime.UtcNow).Days;
        if (daysUntilDue < 0) return Color.Error;
        if (daysUntilDue <= 2) return Color.Warning;
        return Color.Default;
    }

    private string GetDueDateText(DateTime dueDate)
    {
        var daysUntilDue = (dueDate - DateTime.UtcNow).Days;
        if (daysUntilDue < 0) return $"Overdue by {Math.Abs(daysUntilDue)} days";
        if (daysUntilDue == 0) return "Due today!";
        if (daysUntilDue == 1) return "Due tomorrow";
        if (daysUntilDue <= 7) return $"Due in {daysUntilDue} days";
        return dueDate.ToString("MMM dd, yyyy");
    }

    private int GetTaskCountByPriority(int priority)
    {
        if (myTasks == null) return 0;
        return myTasks.Count(t => t.Priority == priority);
    }

    private double GetTaskPercentageByPriority(int priority)
    {
        if (myTasks == null || myTasks.Count == 0) return 0;
        return (double)GetTaskCountByPriority(priority) / myTasks.Count * 100;
    }
}

