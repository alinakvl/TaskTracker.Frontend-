@page "/boards/{BoardId:guid}"
@attribute [Authorize]
@inject IBoardService BoardService
@inject ITaskListService TaskListService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IJSRuntime JS

<PageTitle>@board?.Title - TaskTracker</PageTitle>

@if (isLoading)
{
    <MudProgressLinear Indeterminate=@true />
}
else if (board != null)
{
    <div class="d-flex justify-space-between align-center mb-4">
        <div>
            <MudText Typo=@Typo.h4>@board.Title</MudText>

            @if (!string.IsNullOrEmpty(board.Description))
            {
                <MudText Typo=@Typo.body2
                         Color=@Color.Default>
                    @board.Description
                </MudText>
            }
        </div>

        <div>
            <MudIconButton Icon=@Icons.Material.Filled.People
                           Color=@Color.Primary
                           Title="Board Members"
                           OnClick=@ShowMembers />

            <MudIconButton Icon=@Icons.Material.Filled.Edit
                           Color=@Color.Default
                           Title="Edit Board"
                           OnClick=@EditBoard />

            <MudIconButton Icon=@Icons.Material.Filled.Settings
                           Color=@Color.Default
                           Title="Board Settings" />
        </div>
    </div>

    <div class="board-container">
        @foreach (var list in board.TaskLists.OrderBy(l => l.Position))
        {
            <TaskListColumn TaskList=@list
                            BoardId=@board.Id
                            OnTaskUpdated=@LoadBoard
                            OnListDeleted=@LoadBoard />
        }

        <div class="add-list-column">
            @if (showAddList)
            {
                <MudPaper Class="pa-4"
                          Elevation="2">
                    <MudTextField @bind-Value=@newListTitle
                                  Label="List Title"
                                  Variant=@Variant.Outlined
                                  Class="mb-2"
                                  Immediate=@true
                                  MaxLength="100"
                                  @ref=@listTitleField
                                  OnKeyDown=@HandleListKeyDown />

                    <div class="d-flex gap-2">
                        <MudButton Variant=@Variant.Filled
                                   Color=@Color.Primary
                                   OnClick=@CreateList
                                   Disabled=@(isCreatingList || string.IsNullOrWhiteSpace(newListTitle))>
                            @if (isCreatingList)
                            {
                                <MudProgressCircular Size=@Size.Small
                                                     Indeterminate=@true
                                                     Class="mr-2" />
                                <span>Adding...</span>
                            }
                            else
                            {
                                <text>Add List</text>
                            }
                        </MudButton>

                        <MudButton Variant=@Variant.Text
                                   OnClick=@CancelAddList
                                   Disabled=@isCreatingList>
                            Cancel
                        </MudButton>
                    </div>
                </MudPaper>
            }
            else
            {
                <MudButton Variant=@Variant.Filled
                           Color=@Color.Default
                           StartIcon=@Icons.Material.Filled.Add
                           OnClick=@ShowAddList
                           FullWidth=@true
                           Class="add-list-button">
                    Add List
                </MudButton>
            }
        </div>
    </div>
}
else
{
    <MudAlert Severity=@Severity.Error>Board not found</MudAlert>
}

<style>
    .board-container {
        display: flex;
        gap: 16px;
        overflow-x: auto;
        padding-bottom: 16px;
    }

    .add-list-column {
        min-width: 280px;
        flex-shrink: 0;
    }

    .add-list-button {
        min-height: 44px;
        background-color: rgba(0, 0, 0, 0.04);
    }

        .add-list-button:hover {
            background-color: rgba(0, 0, 0, 0.08);
        }
</style>

@code {
    [Parameter]
    public Guid BoardId { get; set; }

    private BoardDetailDto? board;
    private bool isLoading = true;
    private bool showAddList = false;
    private bool isCreatingList = false;
    private string newListTitle = string.Empty;
    private MudTextField<string>? listTitleField;

    protected override async Task OnInitializedAsync()
    {
        await LoadBoard();
    }

    private async Task LoadBoard()
    {
        try
        {
            isLoading = true;
            board = await BoardService.GetBoardByIdAsync(BoardId);

            if (board == null)
            {
                await JS.InvokeVoidAsync("console.error", "Board not found");
            }
            else
            {
                await JS.InvokeVoidAsync("console.log", $"Board loaded: {board.Title} with {board.TaskLists.Count} lists");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error loading board: {ex.Message}");
            Snackbar.Add("Failed to load board", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ShowAddList()
    {
        showAddList = true;
        await Task.Delay(100); 
        if (listTitleField != null)
        {
            await listTitleField.FocusAsync();
        }
    }

    private void CancelAddList()
    {
        showAddList = false;
        newListTitle = string.Empty;
    }

    private async Task CreateList()
    {
        if (string.IsNullOrWhiteSpace(newListTitle))
        {
            Snackbar.Add("List title is required", Severity.Warning);
            return;
        }

        try
        {
            isCreatingList = true;

            var createDto = new CreateTaskListDto
            {
                Title = newListTitle.Trim(),
                BoardId = BoardId
            };

            await JS.InvokeVoidAsync("console.log", "Creating list:", createDto.Title);

            var created = await TaskListService.CreateTaskListAsync(createDto);

            if (created != null)
            {
                await JS.InvokeVoidAsync("console.log", "List created:", created.Id);

                Snackbar.Add($"List '{created.Title}' created!", Severity.Success);
                newListTitle = string.Empty;
                showAddList = false;

              
                await LoadBoard();
            }
            else
            {
                await JS.InvokeVoidAsync("console.error", "List creation returned null");
                Snackbar.Add("Failed to create list", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", "Error creating list:", ex.Message);
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            isCreatingList = false;
        }
    }

    private async Task HandleListKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(newListTitle))
        {
            await CreateList();
        }
        else if (e.Key == "Escape")
        {
            CancelAddList();
        }
    }

    private async Task EditBoard()
    {
        if (board == null) return;

        var boardDto = new BoardDto
        {
            Id = board.Id,
            Title = board.Title,
            Description = board.Description,
            BackgroundColor = board.BackgroundColor,
            OwnerId = board.OwnerId
        };

        var parameters = new DialogParameters<EditBoardDialog>
        {
            { x => x.Board, boardDto }
        };

        var dialog = await DialogService.ShowAsync<EditBoardDialog>("Edit Board", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadBoard();
        }
    }

    private async Task ShowMembers()
    {
        if (board == null) return;

        var boardDto = new BoardDto
        {
            Id = board.Id,
            Title = board.Title,
            OwnerId = board.OwnerId,
            MembersCount = board.Members?.Count ?? 0
        };

        var parameters = new DialogParameters<BoardMembersDialog>
        {
            { x => x.Board, boardDto }
        };

        await DialogService.ShowAsync<BoardMembersDialog>("Board Members", parameters, new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        });
    }
}

